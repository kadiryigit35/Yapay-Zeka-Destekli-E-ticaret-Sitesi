@using eTicaretSitesi.MvcWebUI.Entity
@model urun

@{
    ViewBag.Title = "Ürün Detayları";
    bool isFavorited = ViewBag.IsFavorited ?? false;
    bool isAuthenticated = User.Identity.IsAuthenticated;
}

<style>
    .alert-container {
        min-height: 50px;
        margin-bottom: 10px;
    }

    .alert {
        max-width: 400px;
        margin: 0 auto;
        padding: 10px;
        font-size: 14px;
        opacity: 1;
        transition: opacity 0.5s ease-out;
    }

    .d-flex.gap-2 {
        gap: 10px !important;
    }

    .btn-lg {
        padding: 10px 20px;
        min-width: 160px;
    }

    /* GÖRSEL DÜZENLEMESİ: Görselin kapsayıcısı */
    .product-image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff; /* Arka planı beyaz yapar */
        height: 400px; /* Sabit bir yükseklik verir */
    }

    /* GÖRSEL DÜZENLEMESİ: Padding kaldırıldı, max-height korundu */
    .product-detail-image {
        max-height: 100%; /* Kapsayıcının yüksekliğini aşmamasını sağlar */
        max-width: 100%;
        object-fit: contain;
    }

    .rating-summary .fa-star {
        color: #ffc107;
    }

    .rating-summary .fa-star-o {
        color: #ddd;
    }

    .rating-stars {
        display: inline-flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        font-size: 28px;
        color: #ddd;
        cursor: pointer;
    }

        .rating-stars .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: #ffc107;
        }
</style>

<div id="detay" class="container pb-5 mt-4">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm rounded-3 border-0 product-image-container">
                <img src="~/Upload/@Model.Resim" class="img-fluid rounded-3 product-detail-image" alt="@Model.Adi">
            </div>
        </div>

        <div class="col-lg-6 d-flex flex-column">
            <h1 class="fw-bold">@Model.Adi</h1>

            <div class="d-flex align-items-center my-2 rating-summary">
                @for (int i = 1; i <= 5; i++)
                {
                    if (i <= Model.OrtalamaPuan)
                    {<i class="fa fa-star"></i> }
                    else if (i - 0.5 <= Model.OrtalamaPuan)
                    { <i class="fa fa-star-half-o"></i> }
                    else
                    { <i class="fa fa-star-o"></i>}
                }
            <span class="ms-2" id="ortalama-puan-text">
                @Model.OrtalamaPuan.ToString("F1") (@Model.ToplamPuanSayisi Değerlendirme)
            </span>
            </div>

            <div class="my-2">
                @if (Model.Stok > 0)
                {<span class="badge bg-success fs-6 py-2 px-3">Stokta Var</span> }
                else
                { <span class="badge bg-danger fs-6 py-2 px-3">Tükendi</span>}
            </div>

            <h4 class="text-primary fs-3 mt-4">
                <i class="fa-solid fa-turkish-lira-sign"></i> @Model.Fiyat.ToString("N2") TL
            </h4>

            <div class="mt-2">
                <div class="mt-2">
                    <strong>Satıcı:</strong>
                    <a href="@Url.Action("Profil", "Satici", new { id = Model.saticiId })" class="text-decoration-none fw-bold">
                        @Model.Satici.Adi
                    </a>
                    <span class="ms-2">
                        <i class="fa fa-star" style="color: #ffc107;"></i>
                        @Model.Satici.OrtalamaPuan.ToString("F1")
                        <small class="text-muted">(@Model.Satici.ToplamPuanSayisi)</small>
                    </span>
                </div>
            </div>

            <div class="mt-3">
                <strong>Puan Ver:</strong>
                <div class="rating-stars" data-product-id="@Model.Id">
                    <i class="fa fa-star" data-value="5"></i>
                    <i class="fa fa-star" data-value="4"></i>
                    <i class="fa fa-star" data-value="3"></i>
                    <i class="fa fa-star" data-value="2"></i>
                    <i class="fa fa-star" data-value="1"></i>
                </div>
            </div>

            <div class="alert-container text-center"></div>

            <div class="mt-4 d-flex gap-2">
                <button class="btn btn-primary btn-lg rounded-pill cart-btn"
                        data-product-id="@Model.Id"
                        data-action="@Url.Action("SepeteEkle", "Sepet")"
                        @(Model.Stok == 0 ? "disabled" : "")>
                    <i class="fa fa-cart-arrow-down"></i> Sepete Ekle
                </button>

                <button class="btn btn-outline-danger btn-lg rounded-pill favorite-btn"
                        data-product-id="@Model.Id"
                        data-is-favorited="@isFavorited.ToString().ToLower()"
                        data-action="@(isFavorited ? Url.Action("FavorilerdenKaldir", "Home") : Url.Action("FavorilereEkle", "Home"))">
                    <i class="fa fa-heart"></i> @(isFavorited ? "Favorilerden Kaldır" : "Favorilere Ekle")
                </button>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-lg-12">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-header bg-light">
                    <ul class="nav nav-tabs card-header-tabs" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="pills-aciklama-tab" data-bs-toggle="pill" href="#pills-aciklama" role="tab" aria-controls="pills-aciklama" aria-selected="true">Açıklama</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pills-yorumlar-tab" data-bs-toggle="pill" href="#pills-yorumlar" role="tab" aria-controls="pills-yorumlar" aria-selected="false">Yorumlar</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-aciklama" role="tabpanel" aria-labelledby="pills-aciklama-tab">
                        <p class="mb-0" style="white-space: pre-wrap;">@Html.Raw(Model.Aciklama)</p>
                    </div>
                    <div class="tab-pane fade" id="pills-yorumlar" role="tabpanel" aria-labelledby="pills-yorumlar-tab">
                        @if (Model.Yorumlar != null && Model.Yorumlar.Any())
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var yorum in Model.Yorumlar.OrderByDescending(y => y.Tarih))
                                {
                                    <li class="list-group-item">
                                        <strong>@yorum.KullaniciAdi:</strong> @yorum.Icerik

                                        @if (User.Identity.IsAuthenticated)
                                        {
                                            <button class="btn btn-sm btn-outline-danger float-right sikayet-et-btn"
                                                    data-yorum-id="@yorum.Id"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#sikayetOnayModal">
                                                <i class="fa fa-flag"></i> Şikayet Et
                                            </button>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p>Bu ürün için henüz yorum yapılmamış.</p>
                        }

                        <hr />

                        @if (isAuthenticated)
                        {
                            using (Html.BeginForm("YorumEkle", "Home", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                @Html.HiddenFor(i => i.Id)
                                <div class="form-group">
                                    <label for="Icerik" class="form-label">Yorumunuz</label>
                                    <textarea name="Icerik" id="Icerik" class="form-control" rows="3" placeholder="Ürün hakkındaki düşüncelerinizi paylaşın..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-success mt-2">Yorumu Gönder</button>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning text-center">
                                Yorum yapmak için <a href="@Url.Action("GirisYap", "Hesap", new { returnUrl = Request.RawUrl })" class="alert-link">giriş yapmanız</a> gerekmektedir.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sikayetOnayModal" tabindex="-1" aria-labelledby="sikayetOnayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sikayetOnayModalLabel">Yorumu Şikayet Et</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bu yorumu şikayet etmek istediğinizden emin misiniz?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmSikayetBtn">Evet, Şikayet Et</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Bootstrap sekmelerinin çalışmasını sağlar
            var tabEl = document.querySelectorAll('a[data-bs-toggle="pill"]');
            tabEl.forEach(function (el) {
                el.addEventListener('show.bs.tab', function (event) { });
            });

            function showAlert(message, type = 'danger') {
                var alert = $('<div class="alert alert-' + type + '" role="alert">' + message + '</div>');
                $('.alert-container').html(alert);
                setTimeout(function () { alert.fadeOut('slow', function () { $(this).remove(); }); }, 3500);
            }

            // Puanlama Yıldızlarına Tıklama Olayı
            $('.rating-stars .fa-star').on('click', function () {
                if (!@isAuthenticated.ToString().ToLower()) {
                    showAlert('Puan vermek için giriş yapmalısınız.');
                    return;
                }

                var puan = $(this).data('value');
                var urunId = $(this).parent().data('product-id');
                var antiForgeryToken = $('form[action*="YorumEkle"] input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '@Url.Action("PuanEkle", "Home")',
                    type: 'POST',
                    data: { urunId: urunId, puanDegeri: puan, __RequestVerificationToken: antiForgeryToken },
                    success: function (response) {
                        if (response.success) {
                            showAlert(response.message, 'info');
                            $('#ortalama-puan-text').text(response.ortalamaPuan + ' (' + response.toplamPuan + ' Değerlendirme)');
                        } else {
                            showAlert(response.message, 'warning');
                        }
                    },
                    error: function () {
                        showAlert('Bir hata oluştu, lütfen daha sonra tekrar deneyin.');
                    }
                });
            });

            // Favori Butonuna Tıklama Olayı
            $('.favorite-btn').click(function (e) {
                e.preventDefault();
                if (!@isAuthenticated.ToString().ToLower()) {
                    showAlert('Favorilere eklemek için giriş yapmalısınız.');
                    return;
                }

                var button = $(this);
                var productId = button.data('product-id');
                var actionUrl = button.data('action');
                var antiForgeryToken = $('form[action*="YorumEkle"] input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: { id: productId, __RequestVerificationToken: antiForgeryToken },
                    success: function (response) {
                        if (response.success) {
                            showAlert(response.message, 'info');
                            var isFavoritedNow = button.data('is-favorited') === true;
                            if (isFavoritedNow) {
                                button.html('<i class="fa fa-heart"></i> Favorilere Ekle');
                                button.data('is-favorited', false).data('action', '@Url.Action("FavorilereEkle", "Home")').removeClass('btn-danger').addClass('btn-outline-danger');
                            } else {
                                button.html('<i class="fa fa-heart"></i> Favorilerden Kaldır');
                                button.data('is-favorited', true).data('action', '@Url.Action("FavorilerdenKaldir", "Home")').removeClass('btn-outline-danger').addClass('btn-danger');
                            }
                        } else {
                            showAlert(response.message, 'warning');
                        }
                    },
                    error: function () {
                        showAlert('Bir hata oluştu, lütfen daha sonra tekrar deneyin.');
                    }
                });
            });

            // Sepete Ekle Butonuna Tıklama Olayı
            $('.cart-btn').click(function (e) {
                e.preventDefault();
                var button = $(this);
                var productId = button.data('product-id');
                var actionUrl = button.data('action');
                var antiForgeryToken = $('form[action*="YorumEkle"] input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: { Id: productId, __RequestVerificationToken: antiForgeryToken },
                    success: function (response) {
                        var message = response.message || (response.success ? "Ürün sepetinize eklendi!" : "İşlem başarısız oldu.");
                        showAlert(message, response.success ? "success" : "warning");
                    },
                    error: function () {
                        showAlert('Bir hata oluştu, lütfen daha sonra tekrar deneyin.');
                    }
                });
            });

            // YENİ EKLENEN KOD: Şikayet Et Modal Yönetimi
            var yorumIdToSikayet;
            // Modal açıldığında hangi yoruma tıklandığını sakla
            $('#sikayetOnayModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Modalı tetikleyen buton
                yorumIdToSikayet = button.data('yorum-id');
            });

            // Onay butonuna tıklandığında AJAX isteğini gönder
            $('#confirmSikayetBtn').on('click', function () {
                var antiForgeryToken = $('form[action*="YorumEkle"] input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '@Url.Action("YorumSikayetEt", "Home")',
                    type: 'POST',
                    data: {
                        yorumId: yorumIdToSikayet,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function (response) {
                        // Favorilere eklemedeki gibi bir bildirim göster
                        showAlert(response.message, response.success ? 'info' : 'warning');
                    },
                    error: function () {
                        showAlert('Bir hata oluştu, lütfen daha sonra tekrar deneyin.');
                    },
                    complete: function () {
                        // İşlem tamamlandığında modalı kapat
                        var modalInstance = bootstrap.Modal.getInstance(document.getElementById('sikayetOnayModal'));
                        modalInstance.hide();
                    }
                });
            });

        });
    </script>
}